\chapter{Dynamic reconfigurable configuration method}  \label{chap:study}
%Experiments on Localization Reliability and Improvement

Having studied the estimator's behavior for several different configurations and conditions, there is still uncertainty about the best performance it can achieve. In the considered system, the hydrophone configuration has a decisive role on the achieved precision, as demonstrated. Therefore, a way to optimize the system's estimation would be to choose, for each position of the acoustic source, the configuration that returns the best estimation and thus the one that should be employed.

In a field scenario where a vehicle is searching for an acoustic transmitter, as it is navigating and readjusting its trajectory, the relative direction that is being estimated in real time is changing. Therefore, the system's performance can vary and arises the necessity of having different angles of vision from the hydrophones to the target. To resolve this issue, the proposed method assumes that the used USBL system integrates more than four hydrophones placed in known positions. This way, it is possible to dynamically reconfigure which four hydrophones are used at a time leading to an estimation that is optimal for the available sensors. 

Another possibility is to determine through the same techniques which configuration of four hydrophones, tested in various positions along the vehicle, is the overall best for short and long range estimation. This can lead to a moderate compromise of the estimate accuracy, however decreases the number sensors that are employed and therefore the cost of the system.

This chapter is dedicated to explaining the methodological approach, the main findings and conclusions that were driven from the formulated dynamic reconfigurable configuration method.

\note{descrever mais detalhadamente os temas que vao ser abordados no capitulo}

\note{- tendo em conta a posição do espaço, escolher a melhor configuração\\
	- qual a melhor configuração (ou duas) para curto e longo alcance?\\
	- tendo em conta a configuração qual é o local no espaço que consegue melhor resultados? (cramer rao)}

\section{Monte Carlo Approach} \label{sec:config-perf}

The developed algorithm serves as a tool to determine which is the best available hydrophone configuration for a certain target position. This approach uses a Monte Carlo method which is useful to solve problems that are deterministic in nature through repetition and application of random parameters. Additionally, it makes use of the developed estimator, which is comprehensively explained in \ref{subsec:estimator}, to estimate the target position for each sensor configuration.
		
For this experiment, it is considered a total of nine hydrophones, whose positions are contained in $matrix_{r_{i}}$, defined by table \ref{tab:config-9h}. Each column expresses the coordinates of each hydrophone, $r_i$, where the value of $x_i$ is in the first row, the value of $y_i$ in the second row and the value of $z_i$ in the third row. Additionally, it is assumed $q = 0.1$, $w = 0.1$ and $e = \frac{ \sqrt{2}}{2} * w$.

\begin{table}[!htbp] %use H to adjust
	\begin{center}
		\begin{tabular}{c | c c c c c c c c c}
			\toprule
			& r1 & r2 & r3 & r4	& r5 & r6 & r7 & r8	& r9 \\ \hline 
			\multirow{1}{0.5em}{x} 
			& q & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
			\midrule 
			\multirow{1}{0.5em}{y} 
			& 0 & 0 & 0 & w & -w & e & e & -e & -e\\
			\midrule 
			\multirow{1}{0.5em}{z} 
			& 0 & w & -w & 0 & 0 & e & -e & e & -e \\
			\bottomrule 
		\end{tabular}
		\caption{Position coordinates for an implementation with 9 hydrophones}
		\label{tab:config-9h}
	\end{center}
\end{table}

These positions are arranged so that they can mimic a possible deployment in an AUV, as represented in figure \ref{fig:9h-config}, where hydrophone $r_1$ is placed in front of the vehicle and hydrophones $r_2$ to $r_9$ form a circle with a $10 cm$ radius around the vehicle.

\begin{figure}[!htbp]
	
	\makebox[\textwidth][c]{\includegraphics[width=0.8\textwidth]{figures/9h-config}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Hydrophone positions for an implementation with 9 hydrophones}
	\label{fig:9h-config}
\end{figure}

Since the used configuration has to be three dimensional, it is defined that hydrophone $r_1$ always integrates the configuration as it is the only one that covers a third dimension. Accordingly, the number of possibilities is combinations of three out of eight, $C(8,3)$, making up a total of 56 combinations. Each of these configurations are associated with a number from 1 to 56 and the hydrophones that integrate each of them are outlined in table \ref{tab:long} for consultation when necessary.

Having the system presented, the algorithm will be explained next. For the sake of clarity, the algorithm was outlined in pseudo code and separated into two main parts, where \ref{alg:alg1} is integrated in \ref{alg:alg2}.

\begin{algorithm}
	\setstretch{1.3} 	%increase space between lines
	%\algsetup{linenosize=\scriptsize} 	%adapts font size
	\scriptsize		%makes it smaller, idk
	\caption{Determines the average azimuth errors, elevation errors and MSE for a set of hydrophone configurations}
	\label{alg:alg1}
	\begin{algorithmic}[1]
		\FOR{\texttt{all k configurations}} %k = 1 \textbf{to} n\_config
		\FOR{\texttt{all i estimation repetition}} %i = 1 \textbf{to} accum\_samples
		\STATE\texttt{$estimator(s, config(k), error)$}
		\COMMENT{returns estimate in Cartesian and spherical coordinates}
		\STATE \texttt{accum\_estimate(i) $\gets$ result of the estimator in each repetition} 
		\STATE \texttt{accum\_error\_azimuth(i) $\gets$ azimuth error in each repetition} 
		\STATE \texttt{accum\_error\_elevation(i) $\gets$ elevation error in each repetition} 
		\ENDFOR
		\STATE $mean\_estimate \gets \dfrac{accum\_estimate}{accum\_samples}$
		%\newline
		%\STATE \texttt{Compute the mean and standard deviation of accum\_error\_elevation and accum\_error\_azimuth}
		\STATE
		\STATE $deviation\_azimuth(config) = std(accum\_error\_azimuth);$
		\STATE $deviation\_elevation(config) = std(accum\_error\_elevation);$
		%\newline
		\STATE $error\_azimuth(config) = mean(accum\_error\_azimuth);$
		\STATE $error\_elevation(config) = mean(accum\_error\_elevation);$
		\STATE
		\STATE $mse(config) = \sqrt{\rule{0pt}{8pt}error\_azimuth(config)^{2} + error\_elevation(config)^{2}};$
		%				\newline
		%				\IF {\texttt{$min\_mse > mse(config)$}} 
		%				\STATE	$min\_mse\_config = config$  
		%				\ENDIF
		%				\IF {\texttt{$min\_error\_azimuth > deviation\_azimuth(config)$}} 
		%				\STATE $min\_azimuth\_config = config$  
		%				\ENDIF
		%				\IF {\texttt{$min\_error\_elevation > deviation\_elevation(config)$}} 
		%				\STATE $min\_elevation\_config = config$  
		%				\ENDIF
		\ENDFOR
	\end{algorithmic}
\end{algorithm}

Algorithm \ref{alg:alg1} is dedicated to computing the average azimuth error, elevation error and MSE for each of the $k = 56$ hydrophone configuration, in order to understand which of them achieves the minimum deviations when estimating a specific position. In order to do so, for each possible hydrophone configuration, the chosen acoustic source position $s$ was estimated $i = 1000$ times (line 3), using the developed estimator. This includes an injected error to the TDoA that follows a Gaussian distribution with zero mean and a configurable variance of $\sigma^{2}$, i.e., $e_i \sim \mathcal{N}(0,\,\sigma^{2})$. The result of this repetition would be an estimate cloud around the absolute $s$ position, which indicates the estimation variation achieved by a certain configuration for a specific position in space. At each stage of the repetition, the estimate is accumulated and the errors of azimuth and elevation are calculated, similarly  to the process described in the accuracy analysis \ref{subchap:acc-analy} of the estimator. Therefore, after computing all estimation repetitions, it is possible to extract four essential parameters that define the quality of the estimation for each configuration: a mean estimate (line 8); the azimuth and elevation standard deviations (lines 10 and 11); the azimuth and elevation estimation errors (lines 12 and 13); the MSE (line 15).

Finally, using the obtained parameters it is possible to determine three configurations that lead to the best estimation regarding MSE, azimuth deviation and elevation deviation. However, there are two main issues that this simple algorithm does not take into account:

\begin{enumerate}
	
	\item  For the considered system conditions, the error that is introduced is sufficient to originate different results every time a position $s$ is tested with the same injected error.
	
	\item Assuming that the hydrophone system is deployed in an AUV, it is expected that every hydrophone has a blind spot, where the acoustic source can be located. Even though the transmitted signals could still be received by these hydrophones, they would be distorted and could lead to misinformation so they should not be considered. Consequently the hydrophones that do not have line of sight to the transmitter should be disregarded as well. 
	
\end{enumerate}

In order to resolve both these problems, a second part of logic was developed, which is translated in pseudo code \ref{alg:alg2}.

In order to turn this mechanism more robust and solve the first issue, it is considered that the experiment of algorithm 1 has to be reiterated a defined number of times to obtain coherent and conclusive answers. Having said this, algorithm \ref{alg:alg2} begins with a loop that reiterates $j = 10$ times the logic previously explained. Addressing the second issue, the \textit{line\_of\_sight} function (line 7) is called, serving as filter to determine which hydrophones have line of sight to the estimated position. The mathematical definitions and conditions included in this function as well as the inputs and outputs are better clarified in the next subsection \ref{subsec:lineofsight}. Thereafter, all configurations that have full line of sight to the transmitter are extracted. Meanwhile, the azimuth deviations, elevation deviations and MSE are accumulated in each experiment reiteration (line 8 to 10) so that it is possible to obtain the definitive mean of these parameters for each configuration (line 12 to 14). 

\begin{algorithm}
	\setstretch{1.3} 	%increase space between lines
	%\algsetup{linenosize=\scriptsize} 	%adapts font size
	\scriptsize		%makes it small, idk
	\caption{Determines the overall best configuration for a specific position estimation considering: \\- multiple full experiments (Algorithm 1); \\ - only hydrophones with line of sight to the target.}
	\label{alg:alg2}
	\begin{algorithmic}[1]
		\FOR{\texttt{all j experiment reiterations}} %j = 1 \textbf{to} n\_test
		\STATE {\texttt{**************************}}
		\STATE {\texttt{*** INSERT ALGORITHM 1 ***}}
		\STATE {\texttt{**************************}}
		\STATE
		\STATE $line\_of\_sight(mean\_estimate, matrix_{r_{i}})$
		\COMMENT{returns which hydrophones have line of sight to the target}
		%\STATE {\texttt{Accumulates MSE, azimuth and elevation errors for each configuration in each test}} 
		\STATE
		\STATE \texttt{$reit\_mse = reit\_mse + mse$ }
		\STATE \texttt{$reit\_dev\_azimuth = reit\_error\_azimuth + deviation\_azimuth$ } 
		\STATE \texttt{$reit\_dev\_elevation = reit\_error\_elevation + deviation\_elevation$} 
		%		\STATE \texttt{reit\_MSE(j) $\gets$ MSE of all configurations in each reiteration} 
		%		\STATE \texttt{reit\_error\_azimuth(j) $\gets$ azimuth error of all configurations in each reiteration} 
		%		\STATE \texttt{reit\_error\_elevation(j) $\gets$ elevation error of all configurations in each reiteration} 
		%\STATE {\texttt{Accumulates the best configuration obtained for each round of tests j}}
		\ENDFOR
		%\STATE {\texttt{Computes mean MSE, deviation of azimuth and elevation for each configuration}}
		\STATE \texttt{$mean\_MSE = reit\_mse \div j$ }
		\STATE \texttt{$mean\_dev\_azimuth = reit\_dev\_azimuth \div j$ } 
		\STATE \texttt{$mean\_dev\_elevation = reit\_dev\_elevation \div  j$} 
		\STATE
		\STATE {\texttt{Extract the configurations that contain only hydrophones with line of sight}}  
		\STATE {\texttt{Form matrix with errors of only the configurations with full line of slight}}
		\STATE
		\STATE $[best\_config\_for\_mse,\; \; overall\_min\_mse] = min(overall\_mse)$
		\STATE $[best\_config\_for\_azimuth,\; \; overall\_min\_dev\_azimuth] = min(overall\_dev\_azimuth)$
		\STATE $[best\_config\_for\_elevation,\; \; overall\_min\_dev\_elevation] = min(overall\_dev\_elevation)$
	\end{algorithmic}
\end{algorithm}

At this stage, it is possible to know already which are the configurations that are considered to achieve the minimum errors in each $j$ reiteration and how many times each of them are chosen. However, these are still not filtered, thus they can contain hydrophones that have not line of sight to the acoustic source. Consequently, the next step is to extract only the configuration with full LOS and form three matrices with the azimuth deviations, elevation deviations and MSE of these configurations. Having the final parameters calculated and filtered, the overall best configurations for each of the chosen parameters are given by the minimum of the matrices that contain said parameter (line 19 to 21), i.e. for all configurations with full LOS:

\begin{itemize}
	
	\item  The minimum obtained MSE corresponds to the configuration that more precisely estimates the position $s$ in terms of MSE;
	
	\item The minimum obtained azimuth deviation corresponds to the configuration that more precisely estimates the position $s$ in terms of azimuth;
	
	\item The minimum obtained elevation deviation corresponds to the configuration that more precisely estimates the position $s$ in terms of elevation.
	
\end{itemize}

Additionally, it is possible to obtain the best configuration in terms of azimuth and elevation simultaneously, by computing the mean between the deviation of azimuth and elevation in each of the selected configurations. The minimum value obtained corresponds to the configuration which achieve the minimum the deviation in both parameters simultaneously.

\subsection{Line of sight definition} \label{subsec:lineofsight}

As briefly explained before, when considering a set of hydrophones placed in the surface of an AUV, there will be blind regions for each of the hydrophones. Nonetheless, when an acoustic source is positioned in a blind region of an hydrophone, it still can receive a transmitted signal through reflections on path objects or reverberation in the AUV's surface. Since these signals would be distorted from the original, they could lead to misinformation after the processing if they were to be considered. For this reason, it is essential to exclusively consider configurations whose hydrophones have line of sight (LOS) to the transmitter. 

In the present application, this feature is executed through function $line\_of\_sight$ of algorithm \ref{alg:alg2}, which outputs a vector containing all the hydrophones that have line of sight to the inputted transmitter position, $mean\_estimate$, from the considered set $matrix_{r_{i}}$. 

In order to define which hydrophones have LOS to a specific position in space, a region was defined for each hydrophone as its LOS region, $ls_i$. Thus, three simplifications were initially considered: 
\begin{itemize}
	\item The model for the vehicle is an approximation to a typical shape of an AUV using geometric shapes, as represented in \ref{fig:auv-geo}, composed by a cylinder as the body with $2*w$ of diameter and a cone in the front with height equal to $q$;
	
	\begin{figure}[!htbp]
		\makebox[\textwidth][c]{\includegraphics[width=0.4\textwidth]{figures/auv-geo}}
		\captionsetup{justification=centering,margin=2cm}
		\caption{Model of AUV used to calculate the LOS region}
		\label{fig:auv-geo}
	\end{figure}
	
	\item The regions for a $x \leq 0$ are defined as if the hydrophones were flat in the vehicle's surface, which leads to a simplified definition of the LOS region;
	
	\item Since hydrophone $r_1$ is integrated in every configuration, there is no necessity of defining its LOS region.

\end{itemize}

Having these relations into account, the LOS regions are then defined separately for $x \leq 0$ and $x > 0$. When $x \leq 0$, the second simplification previously mentioned is applied so all $ls_i$ are defined as the region greater/less or equal than the tangential to the position of hydrophone $i$ in plane yz. These tangential equations are defined in \ref{eq:los-s2} to \ref{eq:los-s9}.

\begin{eqnarray}
ls_2 \gets x \leq 0 \; \;  \wedge  \; \; z > r_{2_z} \\
\label{eq:los-s2}
ls_3 \gets x \leq 0 \; \;  \wedge  \; \; z < r_{3_z} \\
\label{eq:los-s3}
ls_4\gets x \leq 0 \; \;  \wedge  \; \; y > r_{4_y}  \\
\label{eq:los-s4}
ls_5\gets 	x \leq 0 \; \;  \wedge  \; \; y < r_{5_y} \\
\label{eq:los-s5}
ls_6 \gets	x \leq 0 \; \; \wedge  \; \; z \; \geq \; - y + w \sqrt{2} \\
\label{eq:los-s6}
ls_7 \gets	x \leq 0 \; \; \wedge  \; \; z \; \leq \; y - w \sqrt{2} \\
\label{eq:los-s7}
ls_8 \gets x \leq 0 \; \; \wedge  \; \;  z \; \geq \; y + w \sqrt{2} \\
\label{eq:los-s8}
ls_9 \gets 	x \leq 0 \; \; \wedge  \; \;  z \; \leq \; - y - w \sqrt{2}
\label{eq:los-s9}
\end{eqnarray}

By evaluating these equations, it is possible to infer that the LOS regions for $x \leq 0$ intersect each other, as illustrated in figure \ref{fig:los-color-s0}. The projection is correspondent to the yz plane with an inverted y-axis, in accordance with the previously presented model of the USBL system. Additionally, each colored line corresponds to the LOS region covered by the hydrophone with the same color. For instance, if a transmitter is located in $s_{cart}(-10,-10,-10)$, by analysis of the schematic it is observable that this position is covered by $ls_3$, $ls_5$ and $ls_9$, thus in line of sight of hydrophones 3,5 and 9.

\begin{figure}[!htbp]
	\makebox[\textwidth][c]{\includegraphics[width=0.6\textwidth]{figures/los-color-regions-back-crop}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Line of sight regions in plane yz for x < 0}
	\label{fig:los-color-s0}
\end{figure}

Analogously, when $x > 0$, all $ls_i$ are defined as the region greater/less or equal than the tangential to the position of hydrophone $i$ in planes xz or xy, depending on the hydrophone's location. Dealing with the hydrophones positioned in the y and z-axis, $r_2$, $r_3$, $r_4$ and $r_5$, it is possible to directly formulate equations that help defining $ls_2$, $ls_3$, $ls_4$ and $ls_5$ since the tangent plane to these hydrophones is perpendicular to referential planes. However, when considering hydrophones $r_6$, $r_7$, $r_8$ and $r_9$, which are not positioned in any referential axis, the tangential plane which passes through the hydrophone and the front limit of the cone is not parallel to any of the referential planes xy, xz or yz. Therefore, the equations that could define these planes require a rotation of the referential axis. In order to counter this issue, since the shape of the model projected in the yz plane is a circle , if hydrophones $r_6$, $r_7$, $r_8$ and $r_9$ are rotated a $45^{\circ}$ angle around the x-axis, they can become coincident with the positions of $r_2$, $r_4$, $r_5$ and $r_3$ respectively. Additionally, when considering this rotation, the position of the transmitter would also be rotated the same angle to maintain their relative positions. Overall, the used equations are defined by relations \ref{eq:los-b2} to \ref{eq:los-b5}, where the regarded $x,y,z$ coordinates are the original transmitter position for $ls_2$, $ls_3$, $ls_4$, $ls_5$, and the rotated transmitter position for $ls_6$, $ls_7$, $ls_8$, $ls_9$.

\begin{eqnarray}
ls_2, \;  ls_6  \gets x > 0 \; \;  \wedge  \; \; z \geq -\frac{w}{q} x + w  \\
\label{eq:los-b2}
ls_3, \;  ls_9 \gets x > 0 \; \;  \wedge  \; \; z \leq \frac{w}{q} x - w  \\
\label{eq:los-b3}
ls_4, \;  ls_7 \gets x > 0 \; \;  \wedge  \; \; y \geq -\frac{w}{q} x + w   \\
\label{eq:los-b4}
ls_5, \;  ls_8 \gets x > 0 \; \;  \wedge  \; \; y \leq \frac{w}{q} x - w  \\
\label{eq:los-b5}
\end{eqnarray}

After evaluating these equations and the limiting planes that they form, the projected regions of LOS for $r_2$, $r_3$, $r_4$ and $r_5$ are illustrated in \ref{fig:los-color-b0}, where their intersection is evident. The regions $ls_2$, $ls_3$, $ls_4$ and $ls_5$ are naturally similar to these, with an additional rotation of $45^{\circ}$ around the x-axis.

\begin{figure}[!htbp]
	\makebox[\textwidth][c]{\includegraphics[width=0.7\textwidth]{figures/projections-los}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Line of sight regions in plane yz for x $\geq$ 0}
	\label{fig:los-color-b0}
\end{figure}

In summary, it is possible to deduce that there is a larger quantity of different configurations that cover the space for $x>0$ than for $x \leq 0$ due to the model of the AUV and the considerations described in the course of this subsection. Therefore it is expected a better estimation for positions of the acoustic source with an azimuth angle between $-90^{\circ}$ and $90^{\circ}$.
%-------------------------------------------------------------------------
%\subsection{Limitations of the system}

%- considerations of the line of sight (mathematical approximations) - line of sight has to be defined for the model considered; if format changes, it has to be remade
%-------------------------------------------------------------------------
\subsection{Simulation results}

For the purpose of demonstrating the functionality of the implemented system, various acoustic source positions were tested and the results analyzed.

The first demonstration evaluates the achieved MSE, azimuth deviation and elevation deviation for $s_{cart}(10,10,10)$. After simulating, plot \ref{fig:errors-101010} demonstrate the results, where the obtained parametric errors are illustrated for each of the 56 formulated configurations. Additionally, the configurations which are marked with a red circle correspond to those whose hydrophones all have full line of sight to the transmitter and the green star indicates which is the configuration that achieves the lowest error. The results of this experiment are aggregated in table \ref{tab:montecarlo-best1}. For the present case, the hydrophones considered to have line of sight to the target are $r_2$, $r_4$, $r_6$, $r_7$ and $r_8$. The configuration with lowest MSE and azimuth deviation is number 8, composed by hydrophones $r_1$, $r_2$, $r_4$ and $r_6$, which are the directly closer to the target. The configuration that originates lowest elevation deviation is number 19, composed by $r_1$, $r_2$, $r_7$ and $r_8$, which maximizes the baseline of the sensors with line of sight.

\begin{figure}[!htbp]
	\makebox[\textwidth][c]{\includegraphics[width=1.3\textwidth]{figures/plot-[10,10,10]-1000s-errors}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Errors obtained for all configurations when estimating position (10,10,10)}
	\label{fig:errors-101010}
\end{figure}

Additionally, if the azimuth and elevation deviations are evaluated simultaneously, then the obtained plots can be overlaid to a clear comparison between results. Figure \ref{fig:both-101010} represents this situation where, as the label indicates, the azimuth deviation in degrees is represented by the blue line, the pink line is the elevation deviation in degrees, the red and green circles represent the configurations with line of sight to the target and the green star indicates, once again, the configurations which achieve the minimum deviations in azimuth and elevation. Additionally, the cyan diamond reveals which of the configurations leads to the minimum mean between the azimuth and the elevation deviations. In this case, this corresponds to configuration number 53 which reaches a mean deviation of 0.385 degrees. 

\begin{figure}[!htbp]
	\makebox[\textwidth][c]{\includegraphics[width=0.9\textwidth]{figures/plot-[10,10,10]-1000s-both}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Overlaid azimuth and elevation deviations for all configurations when estimating position (10,10,10)}
	\label{fig:both-101010}
\end{figure}

In a second experiment, position $s_{cart}(100,100,100)$ is tested, which has the same azimuth and elevation angles as the previous position and a norm 10 times larger. For this case, the error range of azimuth and elevation estimation is approximately the same and the norm estimation presents an error around 10 times larger. Additionally, as expected the configurations that lead to the lowest errors are the same as for the first experiment.

A set of tests were executed in order to compare the performance of various positions estimation and to extract behavior patterns for the chosen configurations. The collected data is present in table \ref{tab:montecarlo-best1}, where the position of the transmitter are given in Cartesian coordinates by ($s_x$, $s_y$, $s_z$) and for each of the performance parameters it is presented the obtained best configuration number and the minimum error achieved by it. It should also be noted that the notation $0_{+}$/ $0_{-}$ indicates that for a theoretical position with a coordinate equal to zero it was returned a slightly positive/negative estimate of that same coordinate, due to the injected error.

\begin{table}[!htbp] %use H to adjust
	\begin{center}
		\begin{tabular}{ c c c |c c | c c | c c | c c }
			\toprule
			\multicolumn{3}{c|}{\textbf{$\bm{s_{cart}}$}} & \multicolumn{2}{c|}{\textbf{Azimuth}} & \multicolumn{2}{c|}{\textbf{Elevation}} & \multicolumn{2}{c|}{\textbf{Azimuth+Elevation}} & \multicolumn{2}{c}{\textbf{MSE}}   \\
			\midrule
			\multicolumn{1}{c}{$x$} & $y$ & $z$ & Config & Min  & Config & Min & Config & Min & Config & Min \\
			\midrule
			\multirow{1}{*}{10} & 10 & 10 & 8 & 0.377 & 19 & 0.278 &  53 & 0.385 & 8  & 0.434\\
			\midrule
			\multirow{1}{*}{-10} & -10 & -10 & 30 & 2.412 & 30 & 1.196 &  30 & 1.804 & 30  & 2.142\\
			\midrule
			\multirow{1}{*}{$0_{+}$} & -10 & -10 & 14 & 2.058 & 14 & 0.431 & 14 & 1.244  & 14  & 1.672 \\
			\midrule
			\multirow{1}{*}{100} & $0_{-}$ & $0_{-}$ & 47 & 0.177 & 32 & 0.177  & 11 & 0.284  & 11  & 0.330 \\
			\midrule
			\multirow{1}{*}{$0_{+}$} & 100 & $0_{+}$ & 9 & 0.596 & 16 & 0.425 & 16 & 0.512 & 16 & 0.586 \\
			\midrule
			\multirow{1}{*}{$0_{+}$} & $0_{-}$ & 100 & 37 & 52.572  & 39  & 0.381 & 37 & 26.479  & 39 & 32.602 \\
			\midrule
			\multirow{1}{*}{15} & -10 & 5 & 48 & 0.364 & 3 & 0.218 & 27 & 0.346 & 27 & 0.399 \\
			\bottomrule 
		\end{tabular}
		\caption{Results of Monte Carlo simulation}
		\label{tab:montecarlo-best1}
	\end{center}
\end{table}

Some conclusions can be taken upon the analysis of these results: 
\begin{itemize}
	\item Configurations that achieve the overall minimum errors tend to integrate the LOS hydrophones that attain the larger baseline between them;
	
	\item Transmitter positions that return a higher number of LOS hydrophones, have more possible configurations to choose from and therefore can be more optimized, presenting the lowest errors;
		
	\item The points directly behind the AUV that cover positions with $y$ and $z$ in the range [-w,w], are not contained in any line of sight region;
	
	\item When the transmitter positions have $x \leq 0$, they are in line of sight of less hydrophones than for $x > 0$, so there are fewer possible configurations and the returned best option for the various parameters are more consistent. Consequently, the returned minimum errors are usually higher than for $x > 0$;
	
	\item Transmitter positions that are located near the y-axis, almost in parallel with the circle of hydrophones, are usually covered by only four LOS regions, which correspond to the sensors that are directly closer to the target;
	
	\item For elevation angles close to $90^{\circ}$ and $-90^{\circ}$, the azimuth deviation is much larger than at any other position as expected, since in that region the azimuth angle is more influenced by the injected errors leading to increased deviations.
\end{itemize}

\subsubsection{ Evaluation of the line of sight regions}	

Upon inspecting the overall obtained results and the whole function of the system, a particular analysis is conducted to the mechanism that defines the hydrophones' LOS regions. Therefore, after evaluating the position $s(10,10,10)$ that is expected to have an intermediate amount of hydrophones, two additional positions are tested.

The first position to be tested is $s(-10,-10,-10)$ which inherently has less hydrophones with line of sight, due to the method's limitation for $x \leq 0$. Additionally, since it is located in the seventh octant it is expected to be only in LOS with exactly three hydrophones, thus having only one available configuration with line of sight. After simulating, figure \ref{fig:errors-10-10-10} is obtained which verifies the concepts described. The only configuration with line of sight is number 30, composed by $r_1$, $r_3$, $r_5$ and $r_9$.

\begin{figure}[!htbp]
	\makebox[\textwidth][c]{\includegraphics[width=1.3\textwidth]{figures/plot-[-10,-10,-10]-1000s-errors}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Errors obtained for all configurations when estimating position (-10,-10,-10)}
	\label{fig:errors-10-10-10}
\end{figure}

Then, position $s(100,0,0)$ is tested. Due to its long range location and the fact that it is assumed a conic shape at the front of the vehicle, it is expected that this point has line of sight for every employed hydrophone. Figure \ref{fig:errors-100-0-0} illustrates the simulated results which prove the theoretical expectation.

\begin{figure}[!htbp]
	\makebox[\textwidth][c]{\includegraphics[width=1.3\textwidth]{figures/plot-[100,0,0]-1000s-errors}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Errors obtained for all configurations when estimating position (100,0,0)}
	\label{fig:errors-100-0-0}
\end{figure}

Lastly, an extensive verification process was held in order to ensure that the returned LOS hydrophones were plausible for many other positions. Table \ref{tab:LOS-var-pos} summarizes this search, containing a total of eleven positions spread over each octant and the reference axis. By consulting the hydrophone map illustrated in \ref{fig:9h-config}, it is possible to confirm that for every selected position the returned hydrophones are the logically expected.

\begin{table}[!htbp] %use H to adjust
	\begin{center}
		\begin{tabular}{ c c c c | c }
			\toprule
			\multicolumn{1}{c|}{} & \multicolumn{1}{c}{$s_x$} & $s_y$ & $s_z$ & Hydrophones with LOS\\
			\midrule
			\multicolumn{1}{c|}{x-axis} & \multirow{1}{*}{100} & 0 & 0 & 2, 3, 4, 5, 6, 7, 8, 9 \\
			\midrule
			\multicolumn{1}{c|}{y-axis} & \multirow{1}{*}{0} & 100 & 0 & 4, 6, 7 \\
			\midrule
			\multicolumn{1}{c|}{z-axis} & \multirow{1}{*}{0} & 0 & 100 & 2, 6, 8  \\
			\midrule
			\multicolumn{1}{c|}{$1^{st}$ octant} & \multirow{1}{*}{10} & 10 & 10 & 2, 4, 6, 7, 8 \\
			\midrule
			\multicolumn{1}{c|}{$2^{nd}$ octant} & \multirow{1}{*}{5} & 5 & -1 & 2, 3, 4, 6, 7 \\
			\midrule
			\multicolumn{1}{c|}{$3^{rd}$ octant} & \multirow{1}{*}{1} & -1 & 0 & 2, 3, 5, 8, 9  \\
			\midrule
			\multicolumn{1}{c|}{$4^{th}$ octant} & \multirow{1}{*}{1} & -10 & -10 & 3, 5, 7, 8, 9 \\
			\midrule
			\multicolumn{1}{c|}{$5^{th}$ octant} & \multirow{1}{*}{-100} & 10 & 10 & 2, 4, 6  \\
			\midrule
			\multicolumn{1}{c|}{$6^{th}$ octant} & \multirow{1}{*}{-1 } & 10 & -5 & 3, 4, 6, 7  \\
			\midrule
			\multicolumn{1}{c|}{$7^{th}$ octant} & \multirow{1}{*}{-1} & -1 & 1 & 2, 5, 8 \\
			\midrule
			\multicolumn{1}{c|}{$8^{th}$ octant} & \multirow{1}{*}{-1} & -100 & -10 & 3, 5, 8, 9 \\
			\bottomrule 
		\end{tabular}
		\caption{Hydrophones with line of sight for various positions}
		\label{tab:LOS-var-pos}
	\end{center}
\end{table}
	
\subsection{Optimal solution based on range} \label{subsec:opt-range}

After having a comprehensive understanding on the system that is capable of determining which is the best configuration of hydrophones to estimate a specific transmitter position, an alternate scenario can be explored. We now consider that the USBL system does not reconfigure which sensor configuration it should use in order to optimize the estimation  in real time. Instead, a performance study is conducted beforehand so that only two configurations are chosen to be deployed, corresponding to the ones which return the average best estimation of short and long range positions. This way, it would be possible to alternate which configuration is used depending solely on the distance to the target. Alternatively, it is also possible to define just one overall best configuration, in cases where there is the necessity of reducing the number of deployed hydrophones or if the two obtained configurations do not have a significant difference in performance.

In the development of this mechanism, there are some adjustments and similarities from the conditions established for the previous system. Firstly, it is assumed that the hydrophones are implemented in a structure shaped like an AUV with no physical form, thus all hydrophone positions have line of sight to any point in space. Additionally, the possibilities for the hydrophone locations are increased for a more extensive study. Once again, hydrophone $r_1$ is integrated in all configurations and a total of 24 possibilities are considered for the remnant three. These include the same 8 positions $r_2$ to $r_9$, established for the initial setup, to which are added positions $r_{10}$ to $r_{25}$ defined in table \ref{tab:config-25h}. This addition corresponds to two replicated circles from the initial one, that assume the same $y$ and $z$ coordinates but are deviated from each other a $d\_x$ equal to 20 centimeters. Figure \ref{fig:24h-config} illustrates all the considered possible positions for the hydrophone's deployment. Accordingly, the number of possibilities is not correspondent to combinations of three out of 24, $C(24,3)$, since these contain linearly dependent configurations, which correspond to hydrophones' positions that only differ in the $x$ coordinate. Therefore, the total number of available combinations is 1512.

\begin{table}[!htbp] %use H to adjust
	\begin{center}
		\makebox[\textwidth]{%
		\begin{tabular}{c | c c c c c c c c c c c c c c c c}
			\toprule
			& $r_{10}$ & $r_{11}$ & $r_{12}$ & $r_{13}$	& $r_{14}$ & $r_{15}$ & $r_{16}$ & $r_{17}$	& $r_{18}$ & $r_{19}$ & $r_{20}$ & $r_{21}$ & $r_{22}$ & $r_{23}$ & $r_{24}$ & $r_{25}$ \\ \midrule 
			\multirow{1}{0.5em}{x} 
			& 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 
			& $d\_x$ & $d\_x$ & $d\_x$ & $d\_x$ & $d\_x$ & $d\_x$ & $d\_x$ & $d\_x$\\
			\midrule 
			\multirow{1}{0.5em}{y} 
			& 0 & 0 & w & -w & e & e & -e & -e
			& 0 & 0 & w & -w & e & e & -e & -e\\
			\hline 
			\multirow{1}{0.5em}{z} 
			& w & -w & 0 & 0 & e & -e & e & -e
			& w & -w & 0 & 0 & e & -e & e & -e \\
			\bottomrule 
		\end{tabular}}
		\caption{Additional coordinates for an implementation with 25 hydrophones}
		\label{tab:config-25h}
	\end{center}
\end{table}

\begin{figure}[!htb]
	\makebox[\textwidth][c]{\includegraphics[width=0.9\textwidth]{figures/24h-config}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Hydrophone possible positions for optimality study based on range}
	\label{fig:24h-config}
\end{figure}

The applied algorithm is similar to the previously explained algorithms \ref{alg:alg1} and \ref{alg:alg2}, with the following variations:

\begin{enumerate}
	\item Similarly to the condition described in \ref{subchap:acc-analy}, the acoustic source positions, $s$, to be estimated are defined in spherical coordinates, where for each defined norm, the elevation component covers the interval [-90$^{\circ}$ to 90$^{\circ}$] in steps of one and, for each elevation value, the azimuth component covers the interval [-180$^{\circ}$, 180$^{\circ}$] in steps of one, forming partial spheres around the reference axis' origin. The norm covers a range between 1 and 10000 meters.
	
	\item An additional logical loop is added in algorithm \ref{alg:alg1} between lines 1 and 2, so that for each possible configuration all $s$ are estimated a number of $i = 1000$ iterations.
	
	\item the $line\_of\_sight$ function is no longer used, as it is considered that all hydrophones have line of sight to every position $s$.
\end{enumerate}

From here it is possible to analyze which are the best returned configurations, according to the chosen parameters MSE, azimuth deviation, elevation deviation and combined azimuth and elevation deviations. According to the numeric errors that are obtained, it is then possible to decide whether there is a single configuration that has evidently a better performance than the others or if there is a pair of configurations that can be used to obtain individually better estimations for short and long range.

\subsubsection{Simulation results}

\note{conditions of the test - numeros iniciais \\
		 fez se o teste ao longo de x normas, de entre 1 e 1000\\
	 	 concluiu-se que ha discrepancias e nao ha uma configuração fixa que é a melhor para curto e/ou longo alcance\\
 	 	 ao analisar os resultados, eu diria que a config x é a melhor para curto e a y  é melhor para longo\\
  	 	  grafico de evolução dos std \\
   	  	  tabela de configs para todas as ranges ?}

\section{Systematic comparison of geometric configurations performance} \label{sec:analysis_config_performance}

Upon having full comprehension of the developed tool for determining the best configuration, it is interesting to compare its performance with widely used techniques. Therefore, the Crámer-Rao lower bound method was additionally implemented to do a systematic study on the performance of several hydrophone configurations.

The fundamental thought process and mathematical notation previously used in \ref{sec:cramer} are applied in the study that will be explained next.

\subsection{Crámer-Rao bound}  \label{sec:cramer-rao-b}

The implementation of the Crámer-Rao bound method can be essentially partitioned in three steps:

\begin{enumerate}
	
	\item Formulate the observations vector
	\item Calculate the Fisher Information Matrix (FIM)
	\item Calculate the determinant of FIM and draw conclusions
	
\end{enumerate}

In this thesis, the number of used hydrophones per estimation is four, so all expressions will be presented for this case.

Firstly, the observation vectors are formulated based on an initial time of arrival $t_0$, which is given by a synchrony mechanism integrated in the global communication system, and the time of arrival based on the vectors that connect the hydrophone positions, $r_i$, to the transmitter, $s$. For a more realistic approach, it is also considered an added noise component that can be approximated to a Gaussian distribution $n_i \sim \mathcal{N}(\mu,\,\sigma^{2})$. 

The four observations vectors are then expressed as \ref{eq:obs-my1} to \ref{eq:obs-my4}.

\begin{eqnarray}
t_1 = t_0 + \frac{s - r_1}{c} + n_1 \\
\label{eq:obs-my1}
t_2 = t_0 + \frac{s - r_2}{c} + n_2 \\
\label{eq:obs-my2}
t_3 = t_0 + \frac{s - r_3}{c} + n_3 \\
\label{eq:obs-my3}
t_4 = t_0 + \frac{s - r_4}{c} + n_4 
\label{eq:obs-my4}
\end{eqnarray}

Then, addressing the second step, all conditions are set to calculate the FIM,  $I(d) \in \mathbb{R}^{3x3}$. In order to do so, if d$_{i}$ = $|| s - r_{i} ||$ is the distance between each sensor and the source, the gradient of the observations vector can be expressed as shown in \ref{eq:grad_fisher}.

\begin{eqnarray}
\nabla_{d}t(d) = \frac{1}{c} 
\begin{bmatrix}
\frac{d_1^T}{||d_1||} \\ 
\addlinespace
\frac{d_2^T}{||d_2||} \\
\vdots \\
\addlinespace
\frac{d_N^T}{||d_N||}
\end{bmatrix}
\label{eq:grad_fisher}
\end{eqnarray}

Additionally, the added noise component is present in the covariance matrix, represented as \ref{eq:covariance}, which integrates the FIM equation.

\begin{eqnarray}
& \Sigma = 
\begin{bmatrix}
\sigma_1^2 & 0 & 0 & 0 \\
0 & \sigma_2^2 & 0 & 0 \\
0 & 0  & \sigma_3^2  & 0 \\
0 & 0 & 0 & \sigma_4^2 
\end{bmatrix}
\label{eq:covariance}
\end{eqnarray}

Overall, the conditions to obtain the FIM matrix are established and, after some mathematical formulation, it can be expressed as \ref{eq:final-fisher}. This function can be validated by a similar study made on TOA based optimal positioning \cite{cramer-bruno}.

\begin{eqnarray}
I(d) = \frac{1}{c^2} 
\begin{bmatrix}
\sum_{n=1}^{N} \frac{d_i d_i^T}{||d_i||^2} \frac{1}{\sigma_i^2}\\
\end{bmatrix}
\label{eq:final-fisher}
\end{eqnarray}

The final step is to calculate the determinant and find its relation to the volume of the \textit{uncertainty ellipsoid}. As mentioned before, in \ref{sec:cramer}, the Fisher Information Matrix determinant returns a deterministic value that represents the quantity of information which can be obtained and, therefore, the objective is to maximize it by respecting the condition $argmax \; det(I(d))$.


In order to evaluate the obtained determinant values, they should be associated with a physical meaning, more specifically an uncertainty volume. In an initial approach the ellipsoid was not considered and instead an uncertainty sphere was analyzed. The radius of the uncertainty sphere, $u_{sphere}$, is expressed as \ref{eq:det-sphere}, which relates the three ellipsoid axis into a single mean radius that originates a figure of the same volume.

\begin{eqnarray}
	& u_{sphere}(d) = \sqrt[2]{\sqrt[3]{det(I(d)^{-1})}}
	\label{eq:det-sphere}
\end{eqnarray}

In this situation, the optimization objective is expressed as $argmin u_{sphere}(d)$, which indicates that the error that originates a certain uncertainty radius is minimal.

In a further analysis, the uncertainty ellipsoid is also calculated, using \ref{eq:det-ellip}. The squared eigenvalues of the inverse of the FIM indicate the length of each of the three ellipsoid axis and the eigenvectors give the direction of each axis. An eigenvector that is associated with the smaller eigenvalue indicates the direction in which there is less uncertainty and, equivalently, an eigenvector whose eigenvalue is the larger represents the direction in which there is the biggest uncertainty. Consequently, the goal in this case is to minimize the maximum squared eigenvalue of the FIM inverse, $argmin \; max(\sqrt{eigenvalue})$.

\begin{eqnarray}
	& u_{ellipsoid}(d) = \sqrt[2]{eig(I(d)^{-1})}
	\label{eq:det-ellip}
\end{eqnarray}

\subsection{Comparison with Monte Carlo approach}

In order to demonstrate the functionality of the described method, a first simulation was conducted in which a chosen configuration is tested for various positions $s$, returning the uncertainty sphere radius, in meters, that is obtained for each position. Similarly to what was considered before in \ref{subsec:opt-range}, for each defined norm, the elevation component covers the interval [-90$^{\circ}$ to 90$^{\circ}$] in steps of one and, for each elevation value, the azimuth component covers the interval [-180$^{\circ}$, 180$^{\circ}$] in steps of one, forming partial spheres around the reference axis' origin. In this section, all $s$ coordinates will be presented in spherical coordinates. The simulation was conducted using configuration C, which is represented in \ref{tab:config-fim} where the columns $r_{Ci}$ contain the position's coordinates of each hydrophone $i$.

\begin{table}[!htbp] %use H to adjust
	\begin{center}
		\begin{tabular}{ c | c c c c}
			\toprule
			% \cline{2-9}
			\multicolumn{1}{c|}{} &$r_{C1}$& $r_{C2}$ & $r_{C3}$ & $r_{C4}$ \\
			\midrule
			\multirow{1}{0.5em}{x} & 0.1 & 0 & 0 & 0  \\
			%\hline 
			\multirow{1}{0.5em}{y} & 0 & 0 & -0.0707 & 0.0707 \\
			%\hline 
			\multirow{1}{0.5em}{z} & 0 & 0.1 & -0.0707  & -0.0707\\
			\bottomrule 
		\end{tabular}
		\caption{Hydrophone configuration used for FIM simulations}
		\label{tab:config-fim}
	\end{center}
\end{table}

The results are illustrated in figure \ref{fig:fim-100-C}, which show the obtained uncertainty sphere radius for each of the $s$ positions, with respect to azimuth and elevation angles. The first plot represents the 3D map of each radius in relation to both angles, the second plot is a 2D view of the uncertainty with respect to the azimuth angle  in degrees and the third plot is the 2D view of the uncertainty with respect to elevation angle in degrees.

\begin{figure}[!htb]
	\makebox[\textwidth][c]{\includegraphics[width=1.2\textwidth]{figures/plot-FIM-allpos-norm100-C}}
	\captionsetup{justification=centering,margin=2cm}
	\caption{Uncertainty radius for all $s$ positions using configuration C}
	\label{fig:fim-100-C}
\end{figure}

In this specific case, it is noticeable that this configuration is capable of better estimations for low elevation angles and has an increasing error for elevation angles closer to the limits. Then the error has a tendency to increase for azimuth angles around $-90^{\circ}$ and $90^{\circ}$. Overall, for a norm equal to $100 m$, the standard deviation of all estimations is $0.0029m$ and the best estimation occurred for position $s(100,-180,3)$ in spherical coordinates, with an uncertainty radius of $0.0532m$.

%Although the Monte Carlo approach and the Crámer-Rao bound method use a decision factor distinct from the developed dynamic reconfigurable method, it is still worth to understand the differences between the implementations.

\note{estimator is considered not efficient,` à partida vao dar resultados diferentes}


- tabela que para cada posição de 4 hidrofones, indica:
\\
- raio de incerteza maximo e posição no espaço onde ocorreu
\\
-raio de incerteza minimo e posição no espaço onde ocorreu
\\
- desvio padrao de todos os pontos no espaço
\\
- uncertainty ellipsoid 
\\
plot do raio de incerteza para todas as posições no espaço de uma certa configuração

\note{plot da nuvem de pontos e eigen vectors sobrepostos}
\note{comparar best configuration for short and long range}

\note{analyze plane wavefront solution for estimator somwhere}

\section{Conclusions}

\note{-planar wavefront is more simillar to cramer rao for long range source position estimation (discards the non linear components as cramer rao, has some limitations)\\
- cramer rao and monte carlo give different results because my estimator contains non linear components}